#!/bin/bash

# Torrust Tracker Demo Installation Script
# This script creates the required directory structure for the application.
# Following 12-factor principles, it expects .env to be provided by the infrastructure layer.

if ! [ -f "./.env" ]; then
	echo "ERROR: Environment file './.env' not found!"
	echo "The .env file must be provided by the infrastructure configuration system."
	echo "Expected location: $(pwd)/.env"
	echo ""
	echo "To generate the .env file, run:"
	echo "  make configure-local    # For local development"
	echo "  make configure-production # For production deployment"
	exit 1
fi

echo "Found environment file: ./.env"

## Proxy

mkdir -p ./storage/proxy/etc/nginx-conf
mkdir -p ./storage/proxy/webroot
mkdir -p ./storage/dhparam

# Verify nginx configuration exists (should be provided by infrastructure)
if ! [ -f "./storage/proxy/etc/nginx-conf/nginx.conf" ]; then
	echo "ERROR: Nginx configuration file './storage/proxy/etc/nginx-conf/nginx.conf' not found!"
	echo "This file should be generated by the infrastructure configuration system."
	echo "Expected location: $(pwd)/storage/proxy/etc/nginx-conf/nginx.conf"
	echo ""
	echo "To generate the configuration file, run:"
	echo "  make configure-local    # For local development"
	echo "  make configure-production # For production deployment"
	exit 1
fi

echo "Found nginx configuration: ./storage/proxy/etc/nginx-conf/nginx.conf"

## Certbot

mkdir -p ./storage/certbot/etc
mkdir -p ./storage/certbot/lib

## Tracker

# Generate the Tracker sqlite database directory and file if it does not exist
mkdir -p ./storage/tracker/lib/database

if ! [ -f "./storage/tracker/lib/database/sqlite3.db" ]; then
	echo "Creating tracker database: './storage/tracker/lib/database/sqlite3.db'"
	sqlite3 "./storage/tracker/lib/database/sqlite3.db" "VACUUM;"
fi

mkdir -p ./storage/tracker/etc

# Verify tracker configuration exists (should be provided by infrastructure)
if ! [ -f "./storage/tracker/etc/tracker.toml" ]; then
	echo "ERROR: Tracker configuration file './storage/tracker/etc/tracker.toml' not found!"
	echo "This file should be generated by the infrastructure configuration system."
	echo "Expected location: $(pwd)/storage/tracker/etc/tracker.toml"
	echo ""
	echo "To generate the configuration file, run:"
	echo "  make configure-local    # For local development"
	echo "  make configure-production # For production deployment"
	exit 1
fi

echo "Found tracker configuration: ./storage/tracker/etc/tracker.toml"

## Prometheus

mkdir -p ./storage/prometheus/etc

# Verify prometheus configuration exists (should be provided by infrastructure)
if ! [ -f "./storage/prometheus/etc/prometheus.yml" ]; then
	echo "ERROR: Prometheus configuration file './storage/prometheus/etc/prometheus.yml' not found!"
	echo "This file should be generated by the infrastructure configuration system."
	echo "Expected location: $(pwd)/storage/prometheus/etc/prometheus.yml"
	echo ""
	echo "To generate the configuration file, run:"
	echo "  make configure-local    # For local development"
	echo "  make configure-production # For production deployment"
	exit 1
fi

echo "Found prometheus configuration: ./storage/prometheus/etc/prometheus.yml"

echo "Installation completed successfully!"
echo "All required directories created and configuration files verified."
