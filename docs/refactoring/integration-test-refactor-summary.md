# Integration Test Refactor Summary

> **Note**: This document describes interim changes made during the 12-factor refactoring process.
> It should be removed once the refactoring described in `infrastructure/docs/refactoring/twelve-factor-refactor/`
> is completed.

## Overview

This document summarizes the changes made to align the integration testing workflow with the 12-factor
configuration principles currently being implemented in the Torrust Tracker Demo project.

## Changes Made

### 1. Updated `setup_torrust_tracker` Function (infrastructure/tests/test-integration.sh)

**Previous Approach:**

- Used `rsync` to copy the entire local repository with exclusions
- Fallback to `.env.production` if `.env` was missing
- Ad-hoc configuration handling

**New Approach:**

- Uses `git archive` to export only git-tracked files (equivalent to cloning but with current working
  version)
- Runs `make configure-local` to generate configuration files using the new infrastructure system
- Executes the official `application/share/bin/install.sh` script locally
- Copies the properly configured `storage/` folder to the VM
- Verifies critical configuration files exist on the VM

**Benefits:**

- Tests the exact version being developed (without untracked files)
- Uses the official installation process instead of custom logic
- Leverages the new 12-factor configuration system
- More robust and maintainable

### 2. Updated Installation Script (application/share/bin/install.sh)

**Previous Approach:**

- Created `.env` from `.env.production` if missing
- Copied configuration files from default templates

**New Approach:**

- Fails if `.env` is not present (12-factor principle)
- Expects configuration files to be pre-generated by infrastructure system
- Verifies that required configuration files exist
- Provides helpful error messages pointing to the infrastructure commands

**Benefits:**

- Follows 12-factor principles strictly
- No more arbitrary copying of default configurations
- Clear error messages guide users to the correct configuration process
- Separation of concerns between infrastructure and application layers

### 3. Updated Documentation

**Changes:**

- Added deprecation notice to `.env.production` file
- Updated integration testing guide to reflect new workflow
- Improved documentation of what files are generated by `make configure-local`

## Workflow Changes

### Before (Old Workflow)

```bash
# Deploy VM
make apply

# Copy repo with rsync and fallback configs
setup_torrust_tracker()  # Custom logic in test script

# Start services
docker compose up -d
```

### After (New Workflow)

```bash
# Deploy VM
make apply

# Generate configuration files locally
make configure-local

# Use git archive to copy only tracked files
git archive HEAD | extract to VM

# Run official installation script locally
./application/share/bin/install.sh

# Copy configured storage folder to VM
rsync storage/ to VM

# Start services
docker compose up -d
```

## Files Modified

1. **infrastructure/tests/test-integration.sh**
   - Refactored `setup_torrust_tracker` function
   - Improved error handling and logging
   - Added proper configuration verification

2. **application/share/bin/install.sh**
   - Now requires `.env` to be present (12-factor principle)
   - Verifies configuration files exist
   - Provides helpful error messages

3. **application/.env.production**
   - Added deprecation notice
   - Updated documentation to point to new configuration system

4. **docs/guides/integration-testing-guide.md**
   - Updated to reflect new configuration file generation

## Migration Notes

### For Developers

- The integration test now uses the official installation process
- Configuration files are generated by the infrastructure system
- The test workflow is more aligned with production deployment

### For Operations

- The installation script now fails fast if configuration is missing
- Clear error messages guide to the correct configuration commands
- No more implicit fallbacks to default configurations

## Testing

All changes have been validated with:

- ✅ Shell script linting (ShellCheck)
- ✅ Markdown linting (markdownlint)
- ✅ YAML linting (yamllint)
- ✅ Full linting pipeline passes

## Next Steps

1. Test the updated integration workflow with `make test`
2. Update any remaining documentation references to `.env.production`
3. Consider removing `.env.production` once migration is complete
4. Update production deployment guides to use the new configuration system

## Benefits Achieved

- **Consistency**: Integration tests now use the same configuration approach as production
- **Maintainability**: Removed custom configuration logic from test scripts
- **Robustness**: Proper error handling and validation
- **12-Factor Compliance**: Configuration is externalized and validated
- **Developer Experience**: Clear error messages and guidance
- **Testing Fidelity**: Tests exactly what's being developed (git-tracked files only)
